<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>(E)BNF parser for parts of the Galaxy ToolConfig syntax with ANTLR | Living Systems</title>

    <link rel="stylesheet" href="/css/main.css">


      <script src="/js/main.js"></script>



</head>
<body>
  <header>
    <h1>Living Systems</h1>

  <nav>
    <ul>
    <li>
      <a href="/">Home</a>
    </li>
    <li>
      <a aria-current="true" class="ancestor" href="/posts/">Posts</a>
    </li>
    <li>
      <a href="/tags/">Tags</a>
    </li>
    </ul>
  </nav>


  </header>
  <main>
    
  <h1>(E)BNF parser for parts of the Galaxy ToolConfig syntax with ANTLR</h1>

  
  
  <time datetime="2011-07-28T09:46:00&#43;02:00">July 28, 2011</time>

  <p>As
<a href="http://saml.rilspace.com/fims-project-status-update-thinking-about-cli-wrapper-xml-formats" target="_blank" rel="noopener">blogged</a>

earlier, I&rsquo;m currently into parsing the syntax of some definitions for
the parameters and stuff of command line tools. As said in the linked
blog post, I was pondering whether to use the <a href="https://bitbucket.org/galaxy/galaxy-central/wiki/ToolConfigSyntax" target="_blank" rel="noopener">Galaxy
Toolconfig</a>

format or the <a href="http://www.docbook.org/tdg/en/html/cmdsynopsis.html" target="_blank" rel="noopener">DocBook CmdSynopsis
format</a>
. It turned
out though Well, that cmdsynopsis lacks the option to specify a list of
valid choices, for a parameter, as is possible in the Galaxy ToolConfig
format (see
<a href="http://wiki.g2.bx.psu.edu/Admin/Tools/Tool%20Config%20Syntax#A.3Coptions.3E_tag_set" target="_blank" rel="noopener">here</a>
),
and thus can be used to generate drop-down lists in wizards etc. which
is basically what I want to do &hellip; so, now I&rsquo;m going with the Galaxy
format after all.</p>
<p>Enter the Galaxy format then. Look at an example code snippet:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>&lt;tool id=<span style="color:#a31515">&#34;sam_to_bam&#34;</span> name=<span style="color:#a31515">&#34;SAM-to-BAM&#34;</span> version=<span style="color:#a31515">&#34;1.1.1&#34;</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;description&gt;converts SAM format to BAM format&lt;/description&gt;
</span></span><span style="display:flex;"><span>  &lt;requirements&gt;
</span></span><span style="display:flex;"><span>    &lt;requirement type=<span style="color:#a31515">&#34;package&#34;</span>&gt;samtools&lt;/requirement&gt;
</span></span><span style="display:flex;"><span>  &lt;/requirements&gt;
</span></span><span style="display:flex;"><span>  &lt;command interpreter=<span style="color:#a31515">&#34;python&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    sam_to_bam.py
</span></span><span style="display:flex;"><span>      --input1=$source.input1
</span></span><span style="display:flex;"><span>      --dbkey=${input1.metadata.dbkey}
</span></span><span style="display:flex;"><span>      #if $source.index_source == &#34;history&#34;:
</span></span><span style="display:flex;"><span>        --ref_file=$source.ref_file
</span></span><span style="display:flex;"><span>      #else
</span></span><span style="display:flex;"><span>        --ref_file=&#34;None&#34;
</span></span><span style="display:flex;"><span>      #end if
</span></span><span style="display:flex;"><span>      --output1=$output1
</span></span><span style="display:flex;"><span>      --index_dir=${GALAXY_DATA_INDEX_DIR}
</span></span><span style="display:flex;"><span>  &lt;/command&gt;
</span></span><span style="display:flex;"><span>  &lt;inputs&gt;
</span></span><span style="display:flex;"><span>    &lt;conditional name=<span style="color:#a31515">&#34;source&#34;</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;param name=<span style="color:#a31515">&#34;index_source&#34;</span> type=<span style="color:#a31515">&#34;select&#34;</span> label=<span style="color:#a31515">&#34;Choose the source for the reference list&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;option value=<span style="color:#a31515">&#34;cached&#34;</span>&gt;Locally cached&lt;/option&gt;
</span></span><span style="display:flex;"><span>        &lt;option value=<span style="color:#a31515">&#34;history&#34;</span>&gt;History&lt;/option&gt;
</span></span><span style="display:flex;"><span>      &lt;/param&gt;
</span></span><span style="display:flex;"><span>      &lt;when value=<span style="color:#a31515">&#34;cached&#34;</span>&gt;
</span></span><span style="display:flex;"><span>      ... cont ...
</span></span></code></pre></div><p>Here I&rsquo;ve got some challenges. XML parsing is easy, even in Java (I use
the Java XPath libs for that). But look inside the <code>&lt;command&gt;</code> tag &hellip;
that&rsquo;s some really non-xml stuff, no? (it is instructions for a python
based template library, used in galaxy). I have to parse this though, in
order to replicate the logic of it &hellip; so what to do? &hellip; well, I
turned to the <a href="http://www.antlr.org/" target="_blank" rel="noopener">ANTLR Parser Generator</a>
.</p>
<h3 id="toc0">ANTLRWorks works nicely out of the box</h3>
<p>I heard a lot of good things about <a href="http://www.antlr.org/" target="_blank" rel="noopener">ANTLR</a>
, like
that it is more easily debugged than typical BNF parsers etc, so the
choice wasn&rsquo;t that hard. I tried the ANTLR for Eclipse, but though it
looks nice, it that was quite buggy, and I couldnt get it to work
properly in neither Eclipse 3.5 or 3.6. So, finally I went with the easy
option and developed my EBNF grammar in
<a href="http://www.antlr.org/works/index.html" target="_blank" rel="noopener">ANTLRWorks</a>
, which is an
integrated Java App, with the correct ANTLR lib already installed etc.
Turned out to work really good!</p>
<p>The grammar I came up with so far (only for the syntax inside the
<!-- raw HTML omitted --> tag so far, though!) is <a href="https://github.com/samuell/galaxy-toolconfig-bnf/blob/master/GalaxyToolConfig.g" target="_blank" rel="noopener">available on
GitHub</a>

&hellip; and below (in condensed syntax to save some space), for you
convenience :)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bnf" data-lang="bnf"><span style="display:flex;"><span>grammar GalaxyToolConfig;
</span></span><span style="display:flex;"><span>options {output=AST;}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>command    : binary (ifstatement param+ (ELSE param+)? ENDIF | param)*;
</span></span><span style="display:flex;"><span>binary     : WORD;
</span></span><span style="display:flex;"><span>ifstatement
</span></span><span style="display:flex;"><span>        : IF (STRING|VARIABLE) EQTEST (STRING|VARIABLE) COLON;
</span></span><span style="display:flex;"><span>param   : DBLDASH WORD* EQ (VARIABLE|STRING);
</span></span><span style="display:flex;"><span>WORD    : (&#39;a&#39;..&#39;z&#39;|&#39;A&#39;..&#39;Z&#39;)(&#39;a&#39;..&#39;z&#39;|&#39;A&#39;..&#39;Z&#39;|&#39;.&#39;|&#39;_&#39;|&#39;0&#39;..&#39;9&#39;)*;
</span></span><span style="display:flex;"><span>VARIABLE
</span></span><span style="display:flex;"><span>        : &#39;$&#39;(&#39;{&#39;)?WORD(&#39;}&#39;)?;
</span></span><span style="display:flex;"><span>STRING  : &#39;&#34;&#39;(&#39;a&#39;..&#39;z&#39;|&#39;A&#39;..&#39;Z&#39;)+&#39;&#34;&#39;;
</span></span><span style="display:flex;"><span>IF      : &#39;#if&#39;;
</span></span><span style="display:flex;"><span>ELSE    : &#39;#else&#39;;
</span></span><span style="display:flex;"><span>ENDIF   : &#39;#end if&#39;;
</span></span><span style="display:flex;"><span>EQ      : &#39;=&#39;;
</span></span><span style="display:flex;"><span>EQTEST  : &#39;==&#39;;
</span></span><span style="display:flex;"><span>DBLDASH : &#39;--&#39;;
</span></span><span style="display:flex;"><span>COLON   : &#39;:&#39;;
</span></span><span style="display:flex;"><span>WS      : (&#39; &#39;|&#39;\t&#39;|&#39;\r&#39;|&#39;\n&#39;) {$channel=HIDDEN;};
</span></span></code></pre></div><p>Suggestions for improvements? :) &hellip; Then go ahead and mail me &hellip;
samuel dot lampa at gmail dot com)</p>
<p>Also, see a little screenshot from ANTLRWorks below:</p>
<p><a href="screenshot-antlrworks_1_4_2.png"><p class="image">
    <img src="screenshot-antlrworks_1_4_2.png" alt=""  />
</p>
</a>
</p>
<p><em>As you can see in the screenshot, the different parts have correctly
been identified as &ldquo;param&rdquo;, &ldquo;if statement&rdquo; and so forth. You can se
also how I can click in the test syntax, to see where in the parse tree
that actual part appears.</em></p>
<p>When done, I just exported the resulting parser code in ANTLRWorks with
<em>&ldquo;Generate &gt; Generate Code&rdquo;</em>, copied the code from the &ldquo;output&rdquo;
folder into my Eclipse project, added the antlr-3.3 jar into the build
path of it, and then ran the <strong>Test</strong>.java file that comes with the
output.</p>
<p>I wanted to do a little more parsing in my test though, so I ended up
with this little test code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#00f">package</span> net.bioclipse.uppmax.galaxytoolconfigparser;
</span></span><span style="display:flex;"><span><span style="color:#00f">import</span> org.antlr.grammar.v3.*;
</span></span><span style="display:flex;"><span><span style="color:#00f">import</span> org.antlr.runtime.ANTLRStringStream;
</span></span><span style="display:flex;"><span><span style="color:#00f">import</span> org.antlr.runtime.CharStream;
</span></span><span style="display:flex;"><span><span style="color:#00f">import</span> org.antlr.runtime.CommonTokenStream;
</span></span><span style="display:flex;"><span><span style="color:#00f">import</span> org.antlr.runtime.RecognitionException;
</span></span><span style="display:flex;"><span><span style="color:#00f">import</span> org.antlr.runtime.TokenStream;
</span></span><span style="display:flex;"><span><span style="color:#00f">import</span> org.antlr.runtime.tree.CommonTree;
</span></span><span style="display:flex;"><span><span style="color:#00f">import</span> org.antlr.runtime.tree.DOTTreeGenerator;
</span></span><span style="display:flex;"><span><span style="color:#00f">import</span> org.antlr.runtime.tree.Tree;
</span></span><span style="display:flex;"><span><span style="color:#00f">import</span> org.antlr.runtime.tree.TreeAdaptor;
</span></span><span style="display:flex;"><span><span style="color:#00f">import</span> org.antlr.stringtemplate.StringTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">class</span> <span style="color:#2b91af">ParseTest</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#008000">// Generated stuff from ANTLR, which I can use to recognize token types</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">final</span> <span style="color:#2b91af">int</span> EOF=-1;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">final</span> <span style="color:#2b91af">int</span> ELSE=4;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">final</span> <span style="color:#2b91af">int</span> ENDIF=5;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">final</span> <span style="color:#2b91af">int</span> WORD=6;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">final</span> <span style="color:#2b91af">int</span> IF=7;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">final</span> <span style="color:#2b91af">int</span> STRING=8;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">final</span> <span style="color:#2b91af">int</span> VARIABLE=9;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">final</span> <span style="color:#2b91af">int</span> EQTEST=10;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">final</span> <span style="color:#2b91af">int</span> COLON=11;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">final</span> <span style="color:#2b91af">int</span> DBLDASH=12;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">final</span> <span style="color:#2b91af">int</span> EQ=13;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">final</span> <span style="color:#2b91af">int</span> WS=14;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#2b91af">void</span> main(String[] args) <span style="color:#00f">throws</span> RecognitionException {
</span></span><span style="display:flex;"><span>        String testString = <span style="color:#a31515">&#34;    sam_to_bam.py&#34;</span>
</span></span><span style="display:flex;"><span>                + <span style="color:#a31515">&#34;      --input1=$source.input1\n&#34;</span>
</span></span><span style="display:flex;"><span>                + <span style="color:#a31515">&#34;      --dbkey=${input1.metadata.dbkey}\n&#34;</span>
</span></span><span style="display:flex;"><span>                + <span style="color:#a31515">&#34;      #if $source.index_source == &#34;</span>history<span style="color:#a31515">&#34;:\n&#34;</span>
</span></span><span style="display:flex;"><span>                + <span style="color:#a31515">&#34;        --ref_file=$source.ref_file\n&#34;</span>
</span></span><span style="display:flex;"><span>                + <span style="color:#a31515">&#34;      #else\n&#34;</span>
</span></span><span style="display:flex;"><span>                + <span style="color:#a31515">&#34;        --ref_file=&#34;</span>None<span style="color:#a31515">&#34;\n&#34;</span>
</span></span><span style="display:flex;"><span>                + <span style="color:#a31515">&#34;      #end if\n&#34;</span>
</span></span><span style="display:flex;"><span>                + <span style="color:#a31515">&#34;      --output1=$output1\n&#34;</span>
</span></span><span style="display:flex;"><span>                + <span style="color:#a31515">&#34;      --index_dir=${GALAXY_DATA_INDEX_DIR}\n&#34;</span>;
</span></span><span style="display:flex;"><span>        CharStream charStream = <span style="color:#00f">new</span> ANTLRStringStream(testString);
</span></span><span style="display:flex;"><span>        GalaxyToolConfigLexer lexer = <span style="color:#00f">new</span> GalaxyToolConfigLexer(charStream);
</span></span><span style="display:flex;"><span>        TokenStream tokenStream = <span style="color:#00f">new</span> CommonTokenStream(lexer);
</span></span><span style="display:flex;"><span>        GalaxyToolConfigParser parser = <span style="color:#00f">new</span> GalaxyToolConfigParser(tokenStream, <span style="color:#00f">null</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System.out.println(<span style="color:#a31515">&#34;Starting to parse ...&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#008000">// GalaxyToolConfigParser.command_return command = parser.command();</span>
</span></span><span style="display:flex;"><span>        CommonTree tree = (CommonTree)parser.command().getTree();
</span></span><span style="display:flex;"><span>        System.out.println(<span style="color:#a31515">&#34;Done parsing ...&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#2b91af">int</span> i = 0;
</span></span><span style="display:flex;"><span>        <span style="color:#00f">while</span> (i&lt;tree.getChildCount()) {
</span></span><span style="display:flex;"><span>            Tree subTree = tree.getChild(i);
</span></span><span style="display:flex;"><span>            System.out.println(<span style="color:#a31515">&#34;Tree child: &#34;</span> + subTree.getText() + <span style="color:#a31515">&#34;, (Token type: &#34;</span> + subTree.getType() + <span style="color:#a31515">&#34;)&#34;</span>);
</span></span><span style="display:flex;"><span>            i++;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#008000">// Generate DOT Syntax tree</span>
</span></span><span style="display:flex;"><span>        <span style="color:#008000">//DOTTreeGenerator gen = new DOTTreeGenerator();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#008000">//StringTemplate st = gen.toDOT(tree);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#008000">//System.out.println(&#34;Tree: \n&#34; + st);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System.out.println(<span style="color:#a31515">&#34;Done!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>&hellip; generating this output:</p>
<pre tabindex="0"><code class="language-log" data-lang="log">Starting ...
Done executing command ...
Subtree text: sam_to_bam.py, (Token type: 6)
Subtree text: --, (Token type: 12)
Subtree text: input1, (Token type: 6)
Subtree text: =, (Token type: 13)
Subtree text: $source.input1, (Token type: 9)
Subtree text: --, (Token type: 12)
Subtree text: dbkey, (Token type: 6)
Subtree text: =, (Token type: 13)
Subtree text: ${input1.metadata.dbkey}, (Token type: 9)
Subtree text: #if, (Token type: 7)
Subtree text: $source.index_source, (Token type: 9)
Subtree text: ==, (Token type: 10)
Subtree text: &#34;history&#34;, (Token type: 8)
Subtree text: :, (Token type: 11)
Subtree text: --, (Token type: 12)
Subtree text: ref_file, (Token type: 6)
Subtree text: =, (Token type: 13)
Subtree text: $source.ref_file, (Token type: 9)
Subtree text: #else, (Token type: 4)
Subtree text: --, (Token type: 12)
Subtree text: ref_file, (Token type: 6)
Subtree text: =, (Token type: 13)
Subtree text: &#34;None&#34;, (Token type: 8)
Subtree text: #end if, (Token type: 5)
Subtree text: --, (Token type: 12)
Subtree text: output1, (Token type: 6)
Subtree text: =, (Token type: 13)
Subtree text: $output1, (Token type: 9)
Subtree text: --, (Token type: 12)
Subtree text: index_dir, (Token type: 6)
Subtree text: =, (Token type: 13)
Subtree text: ${GALAXY_DATA_INDEX_DIR}, (Token type: 9)
Done!
</code></pre><p>&hellip; seemingly I have the stuff I need, for doing some logic parsing
now! :)</p>
<h3 id="toc1">Some words about BNF</h3>
<p>ANTLR is an (E)BNF parser generator. I had heard a little about BNF
before, and was more or less scared off from the topic, thinking it
looked too advanced, but really, I found it isn&rsquo;t that hard at all!</p>
<p>It strikes me that BNF is quite much <em>RegEx</em> but with functions added,
which allows for recursive pattern matching, which you&rsquo;ll need for
anything more advanced, such as nested braces/xml tags etc &hellip; but as
you can see in the example above also, much of the pattern matching
syntax actually has big similarities to RegEx.</p>
<p>In terms of tutorials, for the (E)BNF/ANTLR combo at least, I&rsquo;d highly
recommend <a href="http://vimeo.com/groups/29150/videos/8137747" target="_blank" rel="noopener">this set of screencasts on using ANTLR in
Eclipse</a>
. Though I didn&rsquo;t
use the Eclipse version, these screencasts quickly give you an idea of
how it all works &hellip; I watched at least a bunch of them, and I&rsquo;m happy
I did.</p>
<h3 id="toc2">Links</h3>
<ul>
<li>The EBNF I came up with so far is available on
<a href="https://github.com/samuell/galaxy-toolconfig-bnf/blob/master/GalaxyToolConfig.g" target="_blank" rel="noopener">GitHub</a>
</li>
<li>The generated parser <a href="https://github.com/bioclipse/bioclipse.uppmax/tree/master/plugins/net.bioclipse.uppmax/src/net/bioclipse/uppmax/galaxytoolconfigparser" target="_blank" rel="noopener">is,
too</a>

(Though in another github project)</li>
</ul>

  
  <div>
    <div>Tags:</div>
    <ul>
        <li><a href="/tags/galaxy/">Galaxy</a></li>
        <li><a href="/tags/parsing/">Parsing</a></li>
    </ul>
  </div>


  </main>
  <footer>
    <p>Copyright &copy; 2024 Living Systems. All rights reserved.</p>

  </footer>
</body>
</html>
